  version: 2.1
  orbs:
    codecov: codecov/codecov@1.0.2
  jobs:
    build:
      docker:
        - image: circleci/android:api-29
      working_directory: ~/code

      environment:
        _JAVA_OPTIONS: "-Xms512m -Xmx1024m"
        GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=false"

      steps:
        - checkout
        - restore_cache:
            keys:
              - v1-dependencies-{{ checksum "build.gradle" }}
              - v1-dependencies-
        - run:
            name: Download Dependencies
            command: ./gradlew androidDependencies

        - save_cache:
            paths:
              - ~/.gradle
            key: v1-dependencies-{{ checksum "build.gradle.kts" }}

        - run:
            name: Run all checks
            command: ./gradlew check
        - run:
            name: Run Jacoco
            command: ./gradlew jacocoTestReport
        - codecov/upload:
            file: lib/build/reports/jacoco/jacocoTestDebugUnitTestReport
